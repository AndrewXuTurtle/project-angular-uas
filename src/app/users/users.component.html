<div class="users-container">
  <!-- Page Header with Stats -->
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">
          <mat-icon class="title-icon">groups</mat-icon>
          Users Management
        </h1>
        <p class="page-subtitle">Manage system users, roles, and permissions</p>
      </div>
      <button mat-raised-button color="primary" (click)="openCreateDialog()" class="add-btn">
        <mat-icon>person_add</mat-icon>
        Add New User
      </button>
    </div>
    
    <!-- Quick Stats -->
    <div class="stats-bar">
      <div class="stat-card">
        <mat-icon class="stat-icon total">people</mat-icon>
        <div class="stat-info">
          <span class="stat-value">{{ users.length }}</span>
          <span class="stat-label">Total Users</span>
        </div>
      </div>
      <div class="stat-card">
        <mat-icon class="stat-icon admin">admin_panel_settings</mat-icon>
        <div class="stat-info">
          <span class="stat-value">{{ getAdminCount() }}</span>
          <span class="stat-label">Administrators</span>
        </div>
      </div>
      <div class="stat-card">
        <mat-icon class="stat-icon active">check_circle</mat-icon>
        <div class="stat-info">
          <span class="stat-value">{{ getActiveCount() }}</span>
          <span class="stat-label">Active Users</span>
        </div>
      </div>
      <div class="stat-card">
        <mat-icon class="stat-icon inactive">block</mat-icon>
        <div class="stat-info">
          <span class="stat-value">{{ getInactiveCount() }}</span>
          <span class="stat-label">Inactive Users</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="controls-bar">
    <mat-form-field class="search-field" appearance="outline">
      <mat-label>Search users</mat-label>
      <input matInput [(ngModel)]="searchText" (input)="applyFilter()" placeholder="Search by ID, username...">
      <mat-icon matPrefix>search</mat-icon>
      @if (searchText) {
        <button matSuffix mat-icon-button (click)="searchText = ''; applyFilter()">
          <mat-icon>close</mat-icon>
        </button>
      }
    </mat-form-field>
    
    <!-- Filter Toggle Button -->
    <button mat-stroked-button (click)="showFilters = !showFilters" class="filter-toggle-btn">
      <mat-icon>{{ showFilters ? 'expand_less' : 'expand_more' }}</mat-icon>
      {{ showFilters ? 'Hide' : 'Show' }} Filters
      @if (!filterLevelAll || !filterStatusAll) {
        <span class="filter-active-badge">â€¢</span>
      }
    </button>
  </div>
    
  <!-- Collapsible Filter Section -->
  @if (showFilters) {
    <div class="filter-section" [@slideDown]>
      <div class="filter-card">
        <div class="filter-header">
          <mat-icon>admin_panel_settings</mat-icon>
          <span>User Level</span>
        </div>
        <div class="filter-options">
          <mat-checkbox [(ngModel)]="filterLevelAll" (change)="onLevelAllChange()">All Levels</mat-checkbox>
          <mat-checkbox [(ngModel)]="filterLevelAdmin" [disabled]="filterLevelAll">Admin</mat-checkbox>
          <mat-checkbox [(ngModel)]="filterLevelUser" [disabled]="filterLevelAll">User</mat-checkbox>
        </div>
      </div>

      <div class="filter-card">
        <div class="filter-header">
          <mat-icon>toggle_on</mat-icon>
          <span>Status</span>
        </div>
        <div class="filter-options">
          <mat-checkbox [(ngModel)]="filterStatusAll" (change)="onStatusAllChange()">All Status</mat-checkbox>
          <mat-checkbox [(ngModel)]="filterStatusActive" [disabled]="filterStatusAll">Active</mat-checkbox>
          <mat-checkbox [(ngModel)]="filterStatusInactive" [disabled]="filterStatusAll">Inactive</mat-checkbox>
        </div>
      </div>

      <button mat-raised-button color="primary" (click)="applyFilter()" class="apply-filter-btn">
        <mat-icon>filter_alt</mat-icon>
        Apply Filters
      </button>

      <button mat-button (click)="clearFilters()" class="clear-filter-btn">
        <mat-icon>clear</mat-icon>
        Clear
      </button>
    </div>
  }

  <!-- Loading Indicator -->
  @if (loading) {
    <div class="loading-container">
      <mat-spinner diameter="60"></mat-spinner>
      <p>Loading users...</p>
    </div>
  }

  <!-- User Cards Grid -->
  @if (!loading) {
    <div class="users-grid">
      @for (user of paginatedUsers; track user.id) {
        <mat-card class="user-card">
          <!-- Card Header -->
          <div class="card-header">
            <div class="user-avatar">
              <mat-icon>{{ user.level === 'admin' ? 'admin_panel_settings' : 'person' }}</mat-icon>
            </div>
            <div class="user-badges">
              <span class="badge level-badge" [class.admin]="user.level === 'admin'">
                {{ user.level }}
              </span>
              <span class="badge status-badge" [class.active]="user.is_active">
                {{ user.is_active ? 'Active' : 'Inactive' }}
              </span>
            </div>
          </div>

          <!-- User Info -->
          <div class="card-body">
            <h3 class="user-name">{{ user.username }}</h3>
            <p class="user-id">ID: {{ user.id }}</p>
          </div>

          <!-- Quick Actions -->
          <div class="card-actions">
            <button mat-button (click)="onPanelOpened(user); expandedUserId = user.id!" class="expand-btn">
              <mat-icon>edit</mat-icon>
              Edit Details
            </button>
          </div>
        </mat-card>
      }

      @if (filteredUsers.length === 0 && !loading) {
        <div class="empty-state">
          <div class="empty-state-content">
            <mat-icon class="empty-icon">{{ searchText || !filterLevelAll || !filterStatusAll ? 'search_off' : 'people_outline' }}</mat-icon>
            <h3>{{ searchText || !filterLevelAll || !filterStatusAll ? 'No users found' : 'No users yet' }}</h3>
            <p>{{ searchText || !filterLevelAll || !filterStatusAll ? 'Try adjusting your search or filters' : 'Get started by adding your first user' }}</p>
            @if (!searchText && filterLevelAll && filterStatusAll) {
              <button mat-raised-button color="primary" (click)="openCreateDialog()" class="empty-action-btn">
                <mat-icon>person_add</mat-icon>
                Add First User
              </button>
            }
          </div>
        </div>
      }
    </div>
  }
    <!-- Pagination -->
    @if (filteredUsers.length > 0) {
      <div class="pagination-container">
        <mat-paginator 
          [length]="filteredUsers.length"
          [pageSize]="pageSize"
          [pageSizeOptions]="[10, 20, 30, 50]"
          [pageIndex]="pageIndex"
          (page)="onPageChange($event)"
          showFirstLastButtons>
        </mat-paginator>
      </div>
    }

  <!-- Edit Panel Overlay -->
  @if (expandedUserId && editingUser[expandedUserId]) {
    <div class="edit-overlay" (click)="closeEditPanel()">
      <div class="edit-panel" (click)="$event.stopPropagation()">
        <div class="panel-header">
          <h2>
            <mat-icon>edit</mat-icon>
            Edit User: {{ getUserById(expandedUserId)?.username }}
          </h2>
          <button mat-icon-button (click)="closeEditPanel()">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <div class="panel-content">
          <!-- Basic Info Section -->
          <div class="edit-section">
            <div class="section-header">
              <mat-icon>info</mat-icon>
              <h3>Basic Information</h3>
            </div>
            <div class="form-grid">
              <mat-form-field appearance="outline">
                <mat-label>Username</mat-label>
                <input matInput [value]="getUserById(expandedUserId)?.username" disabled>
                <mat-hint>Username cannot be changed</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Level</mat-label>
                <mat-select [(ngModel)]="editingUser[expandedUserId].level">
                  <mat-option value="admin">
                    <mat-icon>admin_panel_settings</mat-icon>
                    Administrator
                  </mat-option>
                  <mat-option value="user">
                    <mat-icon>person</mat-icon>
                    User
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-slide-toggle 
                [(ngModel)]="editingUser[expandedUserId].is_active"
                color="primary"
                class="status-toggle">
                <span class="toggle-label">
                  <mat-icon>{{ editingUser[expandedUserId].is_active ? 'check_circle' : 'cancel' }}</mat-icon>
                  {{ editingUser[expandedUserId].is_active ? 'Active' : 'Inactive' }}
                </span>
              </mat-slide-toggle>
            </div>
          </div>

          <!-- Business Units Section -->
          <div class="edit-section">
            <div class="section-header">
              <mat-icon>business</mat-icon>
              <h3>Business Units Access</h3>
              <span class="count-badge">{{ getSelectedBUCount(expandedUserId) }} selected</span>
            </div>
            <div class="toggle-grid">
              @for (bu of businessUnits; track bu.id) {
                <div class="toggle-item">
                  <mat-slide-toggle
                    [checked]="isBusinessUnitSelected(expandedUserId, bu.id)"
                    (change)="toggleBusinessUnit(expandedUserId, bu.id)"
                    color="primary">
                    <span class="toggle-label">
                      <mat-icon>business</mat-icon>
                      {{ bu.business_unit }}
                    </span>
                  </mat-slide-toggle>
                </div>
              }
              @if (businessUnits.length === 0) {
                <p class="no-data">
                  <mat-icon>inbox</mat-icon>
                  No business units available
                </p>
              }
            </div>
          </div>

          <!-- Menus Section -->
          <div class="edit-section">
            <div class="section-header">
              <mat-icon>menu</mat-icon>
              <h3>Menu Access</h3>
              <span class="count-badge">{{ getSelectedMenuCount(expandedUserId) }} selected</span>
            </div>
            <div class="toggle-grid">
              @for (menu of allMenus; track menu.id) {
                <div class="toggle-item">
                  <mat-slide-toggle
                    [checked]="isMenuSelected(expandedUserId, menu.id)"
                    (change)="toggleMenu(expandedUserId, menu.id)"
                    color="primary">
                    <span class="toggle-label">
                      <mat-icon class="menu-icon">{{ menu.icon || 'label' }}</mat-icon>
                      {{ menu.nama_menu }}
                    </span>
                  </mat-slide-toggle>
                </div>
              }
              @if (allMenus.length === 0) {
                <p class="no-data">
                  <mat-icon>inbox</mat-icon>
                  No menus available
                </p>
              }
            </div>
          </div>
        </div>

        <!-- Panel Actions -->
        <div class="panel-actions">
          <button mat-button (click)="closeEditPanel()" class="cancel-btn">
            <mat-icon>close</mat-icon>
            Cancel
          </button>
          <button mat-raised-button color="warn" (click)="deleteUser(getUserById(expandedUserId)!); closeEditPanel()">
            <mat-icon>delete</mat-icon>
            Delete User
          </button>
          <button mat-raised-button color="primary" (click)="saveUser(getUserById(expandedUserId)!)">
            <mat-icon>save</mat-icon>
            Save Changes
          </button>
        </div>
      </div>
    </div>
  }
</div>
