<div class="users-container">
  <!-- Page Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">Users Management</h1>
      <p class="page-subtitle">Manage system users with expandable cards</p>
    </div>
    <button mat-raised-button color="primary" (click)="openCreateDialog()">
      <mat-icon>add</mat-icon>
      Add User
    </button>
  </div>

  <!-- Search -->
  <mat-form-field class="search-field" appearance="outline">
    <mat-label>Search users</mat-label>
    <input matInput [(ngModel)]="searchText" (ngModelChange)="applyFilter()" placeholder="Search by ID, username, or name...">
    <mat-icon matPrefix>search</mat-icon>
  </mat-form-field>

  <!-- Loading Indicator -->
  @if (loading) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Loading users...</p>
    </div>
  }

  <!-- User Cards -->
  @if (!loading) {
    <div class="cards-container">
      @for (user of filteredUsers; track user.id) {
        <mat-expansion-panel (opened)="onPanelOpened(user)" class="user-card">
          <!-- Card Header - Collapsed View -->
          <mat-expansion-panel-header>
            <mat-panel-title>
              <div class="card-header-content">
                <div class="user-identity">
                  <mat-icon class="user-icon">person</mat-icon>
                  <div class="user-basic-info">
                    <span class="user-id">ID: {{ user.id }}</span>
                    <span class="user-username">{{ user.username }}</span>
                  </div>
                </div>
                <div class="user-status-chips">
                  <mat-chip [class]="user.level === 'admin' ? 'chip-admin' : 'chip-user'">
                    {{ user.level }}
                  </mat-chip>
                  <mat-chip [class]="user.is_active ? 'chip-active' : 'chip-inactive'">
                    {{ user.is_active ? 'Active' : 'Inactive' }}
                  </mat-chip>
                </div>
              </div>
            </mat-panel-title>
          </mat-expansion-panel-header>

          <!-- Card Content - Expanded View -->
          <div class="card-content">
            @if (editingUser[user.id!]) {
              <div class="edit-form">
                <!-- Basic Info Section -->
                <div class="form-section">
                  <h3 class="section-title">
                    <mat-icon>info</mat-icon>
                    Basic Information
                  </h3>
                  <div class="form-grid">
                    <mat-form-field appearance="outline">
                      <mat-label>Full Name</mat-label>
                      <input matInput [(ngModel)]="editingUser[user.id!].full_name">
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                      <mat-label>Level</mat-label>
                      <mat-select [(ngModel)]="editingUser[user.id!].level">
                        <mat-option value="admin">Admin</mat-option>
                        <mat-option value="user">User</mat-option>
                      </mat-select>
                    </mat-form-field>
                  </div>

                  <div class="form-row">
                    <mat-checkbox [(ngModel)]="editingUser[user.id!].is_active">
                      Active
                    </mat-checkbox>
                  </div>
                </div>

                <!-- Business Units Section -->
                <div class="form-section">
                  <h3 class="section-title">
                    <mat-icon>business</mat-icon>
                    Business Units Access
                  </h3>
                  <div class="checkbox-grid">
                    @for (bu of businessUnits; track bu.id) {
                      <mat-checkbox 
                        [checked]="isBusinessUnitSelected(user.id!, bu.id)"
                        (change)="toggleBusinessUnit(user.id!, bu.id)">
                        {{ bu.business_unit }}
                      </mat-checkbox>
                    }
                    @if (businessUnits.length === 0) {
                      <p class="no-data">No business units available</p>
                    }
                  </div>
                </div>

                <!-- Menus Section -->
                <div class="form-section">
                  <h3 class="section-title">
                    <mat-icon>menu</mat-icon>
                    Menu Access
                  </h3>
                  <div class="checkbox-grid">
                    @for (menu of allMenus; track menu.id) {
                      <mat-checkbox 
                        [checked]="isMenuSelected(user.id!, menu.id)"
                        (change)="toggleMenu(user.id!, menu.id)">
                        {{ menu.nama_menu }}
                      </mat-checkbox>
                    }
                    @if (allMenus.length === 0) {
                      <p class="no-data">No menus available</p>
                    }
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                  <button mat-raised-button color="primary" (click)="saveUser(user)">
                    <mat-icon>save</mat-icon>
                    Save Changes
                  </button>
                  <button mat-raised-button color="warn" (click)="deleteUser(user)">
                    <mat-icon>delete</mat-icon>
                    Delete User
                  </button>
                </div>
              </div>
            }
          </div>
        </mat-expansion-panel>
      }

      @if (filteredUsers.length === 0) {
        <div class="no-users">
          <mat-icon>person_off</mat-icon>
          <p>No users found</p>
        </div>
      }
    </div>
  }
</div>
